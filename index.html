<!DOCTYPE html>
<html>
  <head>
    <title>Population in Singapore, 2021</title>
    <meta charset="UTF-8" />
    <style></style>
  </head>

  <body>
    <h2 style="font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        text-align: center;
        color: slategray;">
      Population in Singapore, 2021
    </h1>
    <svg></svg>
    <script type="module">
      import * as d3 from 'https://cdn.skypack.dev/d3@7';

      let width = 1000,
        height = 600;

      let svg = d3.select('svg').attr('viewBox', '0 0 ' + width + ' ' + height);

      // Load external data
      Promise.all([d3.json('sgmap.json'), d3.csv('population2021.csv')]).then(
        data => {
          console.log(data[0]);
          console.log(data[1]);

          // Map and projection
          var projection = d3
            .geoMercator()
            .center([103.851959, 1.29027])
            .fitExtent(
              [
                [20, 20],
                [980, 580],
              ],
              data[0]
            );

          let geopath = d3.geoPath().projection(projection);

          // Calculate total population (needed to calculate proportions of population per district later)
          var totalPop = 0;
          for (let item of data[1]) {
            if (item['Population'] != '-') {
              totalPop += parseFloat(item['Population']);
            }
          }
          console.log('Total Population:', totalPop);

          svg
            .append('g')
            .attr('id', 'districts')
            .selectAll('path')
            .data(data[0].features)
            .enter()
            .append('path')
            .attr('d', geopath)
            .attr('fill', feature => {
              let subzoneName = feature['properties']['Subzone Name'];
              let areaPopulation = data[1].find(item => {
                return (
                  item['Subzone'].toLowerCase() == subzoneName.toLowerCase()
                );
              });

              if (areaPopulation == null) {
                let planningAreaName =
                  feature['properties']['Planning Area Name'];
                areaPopulation = data[1].find(item => {
                  return (
                    item['Planning Area'].toLowerCase() ==
                    planningAreaName.toLowerCase()
                  );
                });
              }

              var population = areaPopulation['Population'];
              if (population == '-') {
                population = 0.0;
              } else {
                population = parseFloat(population, 10);
              }

              let proportion = (population / totalPop) * 100; // Proportion in percentage

              // Return color based on proportion of population
              if (proportion < 0.0001) {
                return '#FFEBD6';
              } else if (0.0001 <= proportion && proportion < 0.001) {
                return '#F5CBAE';
              } else if (0.001 <= proportion && proportion < 0.01) {
                return '#EBA988';
              } else if (0.01 <= proportion && proportion < 0.1) {
                return '#E08465';
              } else if (0.1 <= proportion && proportion < 1.0) {
                return '#D65C45';
              } else if (1.0 <= proportion && proportion < 2.0) {
                return '#CC3528';
              } else {
                return '#C40A09';
              }
            });
        }
      );
    </script>
  </body>
</html>
